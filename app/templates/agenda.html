<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda | Painel Gestor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- HEADER -->
    <header class="agenda-header">
        <div class="agenda-logo">
            <img src="/static/logo.svg" alt="Afya iCLINIC" style="height:32px;vertical-align:middle;">
        </div>
        <nav class="agenda-nav-icons d-flex align-items-center gap-3">
            <a href="/agenda" class="nav-link" title="Agenda"><i class="bi bi-calendar-event fs-4"></i></a>
            <a href="/prontuarios" class="nav-link" title="Prontu√°rios"><i class="bi bi-journal-medical fs-4"></i></a>
            <a href="/dashboard" class="nav-link" title="Gest√£o"><i class="bi bi-bar-chart-line fs-4"></i></a>
            <a href="/afya-pay" class="nav-link" title="Afya Pay"><i class="bi bi-credit-card-2-front fs-4"></i></a>
            <a href="/marketing" class="nav-link" title="Marketing"><i class="bi bi-megaphone fs-4"></i></a>
            <a href="/outros" class="nav-link" title="Outros"><i class="bi bi-three-dots fs-4"></i></a>
            <!-- Novo Agendamento: abre modal -->
            <button class="btn btn-success btn-sm ms-2" type="button" title="Novo agendamento"
                data-bs-toggle="modal" data-bs-target="#modalNovoAgendamento">
                <i class="bi bi-plus-circle fs-5"></i>
            </button>
        </nav>
    </header>

    <div class="agenda-container">
        <!-- SIDEBAR: Agendamentos do dia -->
        <aside class="agenda-sidebar">
            <strong>Pacientes do dia</strong>
            {% for ag in agendamentos_do_dia %}
                <div class="sidebar-paciente">
                    üïò {{ ag.horario }}<br>
                    <span>{{ ag.nome or ag.usuario }}</span>
                </div>
            {% else %}
                <div class="text-muted mt-2">Nenhum paciente hoje</div>
            {% endfor %}
        </aside>

        <!-- MAIN: Agenda semanal -->
        <main class="agenda-main">
            <div class="agenda-main-header">
                <h2 class="mb-0">{{ user }}</h2>
                <form method="get" action="/buscar-paciente" style="display:inline; position: relative;">
                    <input type="text" name="q" class="form-control form-control-sm" placeholder="Busque um paciente..." style="display: inline-block; width: 200px; vertical-align: middle;">
                    <button type="submit" class="btn btn-primary btn-sm" style="vertical-align: middle; margin-left: 6px;">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>

            <!-- Navega√ß√£o da semana -->
            <div class="agenda-weeknav">
                {% set semana_inicio = semana[0].data %}
                {% set semana_fim = semana[-1].data %}
                {% set data_ant = (datetime.strptime(semana_inicio, "%Y-%m-%d") - timedelta(days=7)).strftime("%Y-%m-%d") %}
                {% set data_prox = (datetime.strptime(semana_inicio, "%Y-%m-%d") + timedelta(days=7)).strftime("%Y-%m-%d") %}
                <a class="btn btn-link" href="/agenda?data_ini={{data_ant}}" title="Semana anterior">
                    <i class="bi bi-chevron-left fs-4"></i>
                </a>
                <a class="btn btn-outline-secondary btn-sm" href="/agenda" title="Voltar para semana atual" style="font-size:0.95em;">
                    Hoje
                </a>
                <span class="datespan">
                    {{semana[0].data_extenso}} &ndash; {{semana[-1].data_extenso}}
                </span>
                <a class="btn btn-link" href="/agenda?data_ini={{data_prox}}" title="Pr√≥xima semana">
                    <i class="bi bi-chevron-right fs-4"></i>
                </a>
            </div>

            <!-- Dias da semana -->
            <div class="agenda-weekdays">
                {% for day in semana %}
                    <div class="{% if day.data == dia_hoje %}highlight{% endif %}">
                        {{ day.dia_semana_extenso[:3] }} {{ day.dia }}/{{ day.mes_extenso[:3] }}
                    </div>
                {% endfor %}
            </div>

            <!-- GRID de hor√°rios -->
            <div class="agenda-timegrid">
                {% for hour in horarios %}
                    <div class="agenda-hourcell">{{ hour }}</div>
                    {% for day in semana %}
                        <div class="agenda-timecell">
                            {% set eventos = agendamentos_map.get(day.data, []) %}
                            {% for ag in eventos if ag.horario == hour %}
                                <span class="agenda-event-badge" data-bs-toggle="modal" data-bs-target="#modalAgendamento{{ag.id}}">
                                    {{ ag.nome or ag.usuario }}<br>
                                    <small>{{ ag.tipo }}</small>
                                </span>
                                <!-- Modal com dados do agendamento -->
                                <div class="modal fade" id="modalAgendamento{{ag.id}}" tabindex="-1" aria-labelledby="modalLabelAg{{ag.id}}" aria-hidden="true">
                                  <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                      <div class="modal-header pb-2">
                                        <h5 class="modal-title" id="modalLabelAg{{ag.id}}">
                                            <i class="bi bi-person-badge me-1"></i> Dados do Agendamento
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                      </div>
                                      <div class="modal-body">
                                        <div class="mb-2"><strong>Nome:</strong> {{ag.nome or '-'}}</div>
                                        <div class="mb-2"><strong>Contato:</strong> {{ag.telefone or '-'}}</div>
                                        <div class="mb-2"><strong>Hor√°rio:</strong> {{ag.data_extenso}} {{ag.horario}}</div>
                                        <div class="mb-2"><strong>Tipo:</strong> {{ag.tipo}}</div>
                                        <div class="mb-2"><strong>Conv√™nio:</strong> {{ag.convenio or '-'}}</div>
                                        <div class="mb-3">
                                            <form method="post" action="/agenda/editar_status/{{ag.id}}" class="d-flex align-items-center gap-2">
                                                <label class="form-label mb-0 me-2 small">Status:</label>
                                                <select name="status" class="form-select form-select-sm w-auto">
                                                    <option value="Agendado" {% if ag.status == 'Agendado' %}selected{% endif %}>Agendado</option>
                                                    <option value="Confirmado" {% if ag.status == 'Confirmado' %}selected{% endif %}>Confirmado</option>
                                                    <option value="Aguardando atendimento" {% if ag.status == 'Aguardando atendimento' %}selected{% endif %}>Aguardando atendimento</option>
                                                    <option value="N√£o compareceu" {% if ag.status == 'N√£o compareceu' %}selected{% endif %}>N√£o compareceu</option>
                                                    <option value="Paciente atendido" {% if ag.status == 'Paciente atendido' %}selected{% endif %}>Paciente atendido</option>
                                                </select>
                                                <button type="submit" class="btn btn-outline-success btn-sm" title="Salvar status"><i class="bi bi-check-lg"></i></button>
                                            </form>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <a href="/agenda/editar/{{ag.id}}" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-pencil"></i> Editar Agendamento
                                            </a>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </main>
    </div>

    <!-- MODAL NOVO AGENDAMENTO -->
    <div class="modal fade" id="modalNovoAgendamento" tabindex="-1" aria-labelledby="modalNovoAgLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="/agenda/adicionar">
            <div class="modal-header">
              <h5 class="modal-title" id="modalNovoAgLabel"><i class="bi bi-plus-circle me-1"></i> Novo Agendamento</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
              
              <div class="mb-2">
                <label class="form-label mb-0">Nome</label>
                <input type="text" name="nome" class="form-control">
              </div>
              <div class="mb-2">
                <label class="form-label mb-0">Telefone</label>
                <input type="text" name="telefone" class="form-control">
              </div>
              <div class="mb-2">
                <label class="form-label mb-0">Tipo</label>
                <input type="text" name="tipo" class="form-control" required>
              </div>
              <div class="mb-2">
                <label class="form-label mb-0">Data</label>
                <input type="date" name="data" class="form-control" required>
              </div>
              <div class="mb-2">
                <label class="form-label mb-0">Per√≠odo</label>
                <input type="text" name="periodo" class="form-control">
              </div>
              <div class="mb-2">
                <label class="form-label mb-0">Hor√°rio</label>
                <input type="time" name="horario" class="form-control" required>
              </div>
              <div class="mb-2">
                <label class="form-label mb-0">Conv√™nio</label>
                <input type="text" name="convenio" class="form-control">
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success"><i class="bi bi-check-circle"></i> Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Suporte flutuante -->
    <div class="agenda-support">
        <img src="https://cdn-icons-png.flaticon.com/512/3875/3875033.png" alt="M√©dica">
        <div>
            <strong>Conhe√ßa o prontu√°rio</strong><br>
            Clique no paciente acima e atenda seu primeiro paciente no prontu√°rio iClinic.
        </div>
    </div>

    <!-- Bootstrap JS para modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>